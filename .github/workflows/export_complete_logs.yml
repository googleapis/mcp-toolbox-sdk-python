# Copyright 2025 Google LLC
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

name: Export Complete Build Logs 
# detects PR test failures and exports complete logs
on:
  check_run:
    types: [completed]

jobs:
  export-logs:
    # Only run for failed Cloud Build PR tests
    if: github.event.check_run.conclusion == 'failure' && contains(github.event.check_run.name, '-pr-')
    
    permissions:
      contents: 'write'
      checks: 'write'  # Need this to update check runs
    
    runs-on: ubuntu-latest
    
    steps:
      # Step 1: Detect and validate the failure
      - name: Process PR test failure
        id: detect
        uses: 'actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd' # v8
        with:
          script: |
            // Script for Cloud Build PR test failures
            const core = require('@actions/core');
            const checkRun = context.payload.check_run || {};
            const checkNameRaw = checkRun.name || '';
            // Remove trailing parenthetical suffixes like ' (toolbox-testing-438616)'
            const checkNameStripped = checkNameRaw.replace(/\s*\(.*\)$/, '');
            const checkName = checkNameStripped.toLowerCase();
            const detailsUrlRaw = checkRun.details_url || '';
            const detailsUrl = detailsUrlRaw.toLowerCase();

            console.log(`Processing check: ${checkNameRaw}`);

            // Heuristic: consider it a Cloud Build PR test if either:
            // - the name contains '-pr-' (covers matrix/py versions)
            // - or it matches the known package patterns
            // Use the stripped name for pattern matching so names like
            // 'core-python-sdk-pr-py313 (toolbox-testing-438616)' match correctly.
            const looksLikePrName = checkName.includes('-pr-') || /\b(core|langchain|llamaindex)-python-sdk-pr\b/i.test(checkNameStripped);

            // Ensure the details URL points to Cloud Build to avoid false positives
            const isCloudBuildUrl = /cloudbuild|cloud-build|console.cloud.google.com\/cloud-build|cloudbuild.googleapis.com/.test(detailsUrl);

            if (!looksLikePrName || !isCloudBuildUrl) {
              console.log(`Skipping non-Cloud Build or non-PR check: name='${checkNameRaw}' url='${detailsUrlRaw}'`);
              core.setOutput('should_export', 'false');
              return;
            }

            console.log(`Processing failed Cloud Build PR test: ${checkNameRaw}`);

            // Extract build ID from Cloud Build URL using a few common patterns
            let buildId = null;
            if (detailsUrlRaw) {
              console.log(`Checking URL: ${detailsUrlRaw}`);
              const buildIdPatterns = [
                /\/builds\/([a-f0-9-]+)/i,           // Standard Cloud Build pattern
                /buildId=([a-f0-9-]+)/i,              // Query parameter pattern
                /\/builds\/(\d+)/                    // Numeric build ID
              ];

              for (const pattern of buildIdPatterns) {
                const match = detailsUrlRaw.match(pattern);
                if (match && match[1]) {
                  buildId = match[1];
                  console.log(`Extracted build ID: ${buildId}`);
                  break;
                }
              }
            }

            if (!buildId) {
              console.log(`Could not extract build ID from: ${detailsUrlRaw}`);
              core.setOutput('should_export', 'false');
              return;
            }

            // Set outputs for next steps
            const sanitizedName = checkNameRaw.replace(/[^a-zA-Z0-9_-]/g, '-');
            core.setOutput('should_export', 'true');
            core.setOutput('build_id', buildId);
            core.setOutput('test_name', sanitizedName);
            core.setOutput('original_name', checkNameRaw);

            console.log(`Ready to export logs for ${checkNameRaw}`);
            console.log(`Artifact will be: complete-logs-${sanitizedName}`);

      # Step 2: Fetch complete logs from Cloud Build
      - name: Authenticate to Google Cloud
        if: steps.detect.outputs.should_export == 'true'
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.CLOUD_BUILD_LOG_VIEWER_SA_KEY }}

      - name: Setup gcloud
        if: steps.detect.outputs.should_export == 'true'
        uses: google-github-actions/setup-gcloud@v2

      - name: Fetch complete logs
        if: steps.detect.outputs.should_export == 'true'
        run: |
          echo " Fetching complete logs for build: ${{ steps.detect.outputs.build_id }}"
          echo " Test: ${{ steps.detect.outputs.original_name }}"
          echo " Project: toolbox-testing-438616"
          
          # Fetch complete logs from Cloud Build (untruncated)
          if gcloud builds log "${{ steps.detect.outputs.build_id }}" \
              --project="toolbox-testing-438616" > complete-logs.txt 2>&1; then
            
            LOG_SIZE=$(wc -c < complete-logs.txt)
            echo "Successfully fetched complete logs (${LOG_SIZE} bytes)"
            
            if [ $LOG_SIZE -eq 0 ]; then
              echo "Warning: Log file is empty" > complete-logs.txt
              echo "This might indicate the build is still running or the build ID is incorrect." >> complete-logs.txt
            fi
            
          else
            echo "Failed to fetch build logs" > complete-logs.txt
            echo "" >> complete-logs.txt
            echo "Build ID: ${{ steps.detect.outputs.build_id }}" >> complete-logs.txt
            echo "Project: toolbox-testing-438616" >> complete-logs.txt
            echo "" >> complete-logs.txt
            echo "This might be due to:" >> complete-logs.txt
            echo "1. Build ID does not exist" >> complete-logs.txt
            echo "2. Build is still in progress" >> complete-logs.txt
            echo "3. Insufficient permissions" >> complete-logs.txt
          fi

      # Step 3: Upload logs and create accessible download link
      - name: Upload complete logs artifact
        if: steps.detect.outputs.should_export == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: complete-logs-${{ steps.detect.outputs.test_name }}
          path: complete-logs.txt
          retention-days: 30

      - name: Create direct download link via GitHub release
        if: steps.detect.outputs.should_export == 'true'
        run: |
          # Create a unique filename for the logs
          LOG_FILE="complete-logs-${{ steps.detect.outputs.test_name }}-$(date +%Y%m%d-%H%M%S).txt"
          cp complete-logs.txt "$LOG_FILE"
          
          # Create or update a release for log storage
          RELEASE_TAG="build-logs-$(date +%Y%m%d)"
          
          # Check if release exists, create if not
          if ! gh release view "$RELEASE_TAG" >/dev/null 2>&1; then
            gh release create "$RELEASE_TAG" \
              --title "Build Logs $(date +%Y-%m-%d)" \
              --notes "Automated release for storing complete build logs" \
              --prerelease
          fi
          
          # Upload log file to release
          gh release upload "$RELEASE_TAG" "$LOG_FILE" --clobber
          
          # Get download URL
          DOWNLOAD_URL="https://github.com/${{ github.repository }}/releases/download/$RELEASE_TAG/$LOG_FILE"
          echo "DOWNLOAD_URL=$DOWNLOAD_URL" >> $GITHUB_ENV
          echo "LOG_FILENAME=$LOG_FILE" >> $GITHUB_ENV
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # Step 4: Add download link to existing failed check run
      - name: Add complete logs check run
        if: steps.detect.outputs.should_export == 'true'
        uses: 'actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd' # v8
        with:
          script: |
            const testName = '${{ steps.detect.outputs.original_name }}';
            const downloadUrl = process.env.DOWNLOAD_URL;
            const buildId = '${{ steps.detect.outputs.build_id }}';

            // Modify original Cloud Build check run only (no fallback)
            const checkRunId = context.payload.check_run.id;
            const originalOutput = context.payload.check_run.output || {};

            // preserve existing title/summary/text
            const originalTitle = originalOutput.title || 'Build details';
            const originalSummary = originalOutput.summary || '';
            let originalText = originalOutput.text || '';

            const linkLine = `- Complete logs: ${downloadUrl}`;
            const sectionHeaderRegex = /(^|\n)(\s*Cloud Build links\s*[:\n])/i;

            if (sectionHeaderRegex.test(originalText)) {
              // insert link after the header line
              originalText = originalText.replace(sectionHeaderRegex, (m, p1, p2) => `${p1}${p2}\n${linkLine}\n`);
            } else {
              // append a Cloud Build links section at the end
              originalText = `${originalText}\n\nCloud Build links:\n${linkLine}\n`;
            }

            // Update check run output, preserving title and summary
            await github.rest.checks.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              check_run_id: checkRunId,
              output: {
                title: originalTitle,
                summary: originalSummary,
                text: originalText
              }
            });

            console.log(`Successfully appended download link to check run ${checkRunId}`);
            console.log(`Download link available: ${downloadUrl}`);


