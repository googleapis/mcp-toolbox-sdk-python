# Copyright 2025 Google LLC
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#      http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

name: Export Complete Build Logs

on:
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch:

jobs:
  detect-failing-tests:
    name: Detect Failing Tests
    runs-on: ubuntu-latest
    permissions:
      contents: read
      checks: read
    outputs:
      failed_check_data: ${{ steps.get_failed_checks.outputs.failed_check_data }}
    steps:
      - name: Get failing status checks for PR
        id: get_failed_checks
        uses: actions/github-script@v6
        with:
          script: |
            try {
              // Determine SHA based on event type
              let sha;
              let eventInfo;
              
              if (context.payload.pull_request) {
                // Pull request event
                sha = context.payload.pull_request.head.sha;
                eventInfo = `PR #${context.payload.pull_request.number}`;
              } 

              console.log(`Checking ${eventInfo} at commit ${sha}`);

              // Get ALL check runs for the ref (paginated)
              let allChecks = [];
              try {
                allChecks = await github.paginate(
                  github.rest.checks.listForRef,
                  {
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    ref: sha,
                  },
                  (response) => response.data.check_runs
                );
                console.log(`Retrieved ${allChecks.length} total check runs`);
              } catch (error) {
                console.log(`Error fetching checks: ${error.message}`);
                core.setOutput('failed_check_data', JSON.stringify([]));
                return;
              }

              // Identify Cloud Build-related checks robustly
              const isCloudBuildCheck = (c) => {
                if (!c) return false;
                const name = (c.name || '');
                const details = (c.details_url || '');
                // Match common variants like "Cloud Build", "cloud-build", plus URL hints
                return /cloud[ -]?build/i.test(name)
                  || /toolbox[- ]?testing/i.test(name)
                  || /cloud-build\/builds\//i.test(details)
                  || /console\.cloud\.google\.com\/cloud-build/i.test(details);
              };

              const failedCloudBuildChecks = allChecks.filter(
                (c) => c && c.status === 'completed' && c.conclusion === 'failure' && isCloudBuildCheck(c)
              );

              console.log(`Found ${failedCloudBuildChecks.length} failed Cloud Build-related checks out of ${allChecks.length} total checks`);

              const failedData = failedCloudBuildChecks.map((c) => ({
                name: c.name || 'Unknown',
                id: c.id || '',
                html_url: c.html_url || '',
                details_url: c.details_url || '',
                external_id: c.external_id || '',
              }));

              core.setOutput('failed_check_data', JSON.stringify(failedData));
              console.log('Failed check data:', JSON.stringify(failedData, null, 2));
              
            } catch (error) {
              console.error(`Unhandled error: ${error.message}`);
              console.error(error.stack);
              core.setOutput('failed_check_data', JSON.stringify([]));
              core.setFailed(`Failed to detect failing tests: ${error.message}`);
            }

      - name: Print detected failed checks
        run: |
          echo "Failed check data: ${{ steps.get_failed_checks.outputs.failed_check_data }}"
